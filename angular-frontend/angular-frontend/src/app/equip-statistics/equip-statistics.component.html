<div #topOfPage></div>

<div class="container-fluid factory-floor py-4 px-3" [class.loading]="isDateFilterLoading"> 
  <!-- Top Bar: Header Info and Recent Activity -->
  <div class="d-flex justify-content-between align-items-start mb-4">
    <!-- Left Side: Back Button & Title -->
    <div>
      <div class="mb-5">
        <button class="btn btn-outline-secondary" onclick="window.history.back()">‚¨Ö Back to Tool List</button>
      </div>
      <div>
        <h2 class="page-title">Equipment Statistics | <span>{{ equipId }}</span></h2>
      </div>
    </div>

    <!-- Right Side: Most Recent Activity Card -->
    <div class="col-lg-5" *ngIf="!isLoading && !isDateFilterLoading">
      <div class="card recent-activity-notice h-100">
        <div class="card-body">
          <div class="activity-header">
            <div class="activity-icon-large">‚ùó</div>
            <div class="activity-title-section">
              <h5 class="activity-title">Most Recent Activity</h5>
              <div class="activity-timestamp" *ngIf="mostRecentEntry">
                {{ formatDate(mostRecentEntry.state_in_date) }}
              </div>
            </div>
          </div>
          
          <div *ngIf="mostRecentEntry" class="activity-content">
            <div class="activity-main-info">
              <div class="error-name-badge">{{ mostRecentEntry.error_name }}</div>
              <div class="event-code-badge">{{ mostRecentEntry.event_code }}</div>
            </div>
            
            <div class="activity-description">
              {{ mostRecentEntry.error_description }}
            </div>
          </div>
          
          <div *ngIf="!mostRecentEntry" class="no-activity">
            <p class="text-muted mb-0">No recent activity found</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Date Filter -->
  <div class="row g-4 mb-4" *ngIf="!isLoading">
    <div class="col-lg-7">
      <app-date-filter
        #dateFilter
        [startDate]="startDate"
        [endDate]="endDate"
        [earliestDate]="statistics?.earliest_error_date || ''"
        (dateRangeChange)="onDateRangeChange($event)"
        (filterCleared)="onFilterCleared()"
        (loadingStarted)="onDateFilterLoadingStarted()"
        (loadingEnded)="onDateFilterLoadingEnded()">
      </app-date-filter>
    </div>
  </div>

  <!-- Overview Cards -->
  <div class="row g-4 mb-4" *ngIf="!isLoading && !isDateFilterLoading">
    <div class="col-lg-3 col-md-6 col-12">
      <!-- Days Since Last Error Card -->
      <div class="card stat-card">
        <div class="card-body text-center">
          <h6 class="stat-label">Days Since Last Error</h6>
          <div class="stat-value">{{ getDaysSinceLastError() }}</div>
          <div class="stat-sub-info">days</div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 col-12">
      <!-- Most Common Error Name Card -->
      <div class="card stat-card">
        <div class="card-body text-center">
          <h6 class="stat-label">Most Common Error Name</h6>
          <div class="stat-value stat-value-longtext">{{ statistics?.most_common_error_name }}</div>
          <div class="stat-sub-info">{{ getErrorCount(statistics?.most_common_error_name) }} occurrence{{ getErrorCount(statistics?.most_common_error_name) === 1 ? '' : 's' }}</div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 col-12">
      <!-- Preventive Maintenance Card -->
      <div class="card stat-card">
        <div class="card-body text-center">
          <h6 class="stat-label">üõ† Preventive Maintenance</h6>
          <div class="stat-value">{{ pmCount }}</div>
          <div class="stat-sub-info" *ngIf="latestPmDate">
            Latest: {{ formatDate(latestPmDate) | slice:0:10 }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 col-12">
      <!-- Most Common Error Location Card -->
      <div class="card stat-card">
        <div class="card-body text-center">
          <h6 class="stat-label">üìç Most Common Error Location</h6>
          <div class="stat-value stat-value-longtext">{{ unfilteredMostCommonErrorLocation }}</div>
          <div *ngIf="unfilteredMostCommonErrorLocationErrors.length > 0" class="mt-2">
            <div class="fw-bold small text-muted mb-1">Corresponding Errors:</div>
            <ul class="list-unstyled mb-0">
              <li *ngFor="let err of unfilteredMostCommonErrorLocationErrors">
                <span class="text-accent">{{ err.name }}</span>
                <span class="text-muted">({{ err.count }})</span>
              </li>
            </ul>
          </div>
          <div class="stat-sub-info mb-2">{{ unfilteredUniqueErrorLocations }} unique locations</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts and Data Tables -->
  <div *ngIf="!isLoading && !isDateFilterLoading">
    <!-- Charts Section -->
    <div class="row g-4 mt-4 justify-content-center">
      <div class="col-12">
        <div class="card chart-card">
          <div class="card-body">
            <h5 class="chart-title">üéØ Error Distribution</h5>
            <ngx-charts-advanced-pie-chart
              [results]="errorNotesData"
              [gradient]="true"
              (select)="onErrorSelect($event)">
            </ngx-charts-advanced-pie-chart>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row g-4 mt-4">
      <!-- Error Trend Line -->
      <div class="col-lg-6">
        <div class="card chart-card">
          <div class="card-body">
            <h5 class="chart-title">üìà Total Error Trend</h5>
            <ngx-charts-line-chart
              [results]="lineChartData"
              [scheme]="colorScheme"
              [xAxis]="true"
              [yAxis]="true"
              [legend]="false"
              [xAxisLabel]="'Month'"
              [yAxisLabel]="'Total Errors'"
              [autoScale]="true"
              [curve]="curve"
              [timeline]="false"
              [showGridLines]="false"
              [yScaleMin]="0"
              (select)="onTrendSelect($event)">
            </ngx-charts-line-chart>
          </div>
        </div>
      </div>
    
      <!-- Monthly Error Count -->
      <div class="col-lg-6">
        <div class="card chart-card">
          <div class="card-body">
            <h5 class="chart-title">üìÖ Monthly Error Count</h5>
            <ngx-charts-bar-vertical-stacked
              [results]="errorFrequencyData"
              [xAxisLabel]="'Month'"
              [legend]="true"
              [legendPosition]="legendPosition"
              [scheme]="colorScheme"
              [xAxisTickFormatting]="formatXAxisTick"
              [yAxisLabel]="'Count'"
              [showXAxisLabel]="true"
              [showYAxisLabel]="true"
              [xAxis]="true"
              [yAxis]="true"
              [gradient]="true"
              (select)="onMonthSelect($event)">
            </ngx-charts-bar-vertical-stacked>
          </div>
        </div>
      </div>
    </div>

    <!-- WorkWeek Charts Section -->
    <div class="row g-4 mt-4">
      <!-- WorkWeek Error Trend Line -->
      <div class="col-lg-6">
        <div class="card chart-card">
          <div class="card-body">
            <h5 class="chart-title">üìà Total Error Trend (WorkWeek)</h5>
            <ngx-charts-line-chart
              [results]="lineChartWorkWeekData"
              [scheme]="colorScheme"
              [xAxis]="true"
              [yAxis]="true"
              [legend]="false"
              [xAxisLabel]="'WorkWeek'"
              [yAxisLabel]="'Total Errors'"
              [autoScale]="true"
              [curve]="curve"
              [timeline]="false"
              [showGridLines]="false"
              [yScaleMin]="0"
              (select)="onWorkWeekTrendSelect($event)">
            </ngx-charts-line-chart>
          </div>
        </div>
      </div>
    
      <!-- WorkWeek Error Count -->
      <div class="col-lg-6">
        <div class="card chart-card">
          <div class="card-body">
            <h5 class="chart-title">üìÖ WorkWeek Error Count</h5>
            <ngx-charts-bar-vertical-stacked
              [results]="errorFrequencyWorkWeekData"
              [xAxisLabel]="'WorkWeek'"
              [legend]="true"
              [legendPosition]="legendPosition"
              [scheme]="colorScheme"
              [xAxisTickFormatting]="formatXAxisTick"
              [yAxisLabel]="'Count'"
              [showXAxisLabel]="true"
              [showYAxisLabel]="true"
              [xAxis]="true"
              [yAxis]="true"
              [gradient]="true"
              (select)="onWorkWeekSelect($event)">
            </ngx-charts-bar-vertical-stacked>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Alert -->
    <div *ngIf="selectedErrorName" class="alert alert-filter mt-5 d-flex justify-content-between align-items-center px-4 py-3 rounded">
      <div>
        <span class="filter-icon">üîç</span> <strong>Filtered by:</strong> <span class="text-highlight">{{ selectedErrorName }}</span>
      </div>
      <button class="btn btn-sm btn-outline-light" (click)="clearErrorFilter()">‚úñ Clear Filter</button>
    </div>

    <!-- Error Location Charts and Details (moved above Error Entries) -->
    <div class="row g-4 mt-4" *ngIf="filteredEntries.length > 0" id="error-location-section" #errorLocationSection>
      <div class="col-lg-6">
        <div class="card chart-card chart-card-equal-height">
          <div class="card-body">
            <h5 class="chart-title">üìç Error Locations Distribution</h5>
            <div *ngIf="errorLocationData.length > 0">
              <ngx-charts-pie-chart
                [results]="errorLocationData"
                [gradient]="true"
                [scheme]="colorScheme"
                [legend]="true"
                [legendPosition]="legendPosition"
                [labels]="true"
                [doughnut]="false"
                [arcWidth]="0.6"
                (select)="onErrorLocationSelect($event)">
              </ngx-charts-pie-chart>
            </div>
            <div *ngIf="errorLocationData.length === 0" class="text-center py-4">
              <div class="text-muted">
                <i class="fas fa-info-circle mb-2"></i>
                <p class="mb-0">No location data available for the selected filter.</p>
                <small>This may occur when error locations cannot be extracted from the error descriptions.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card chart-card chart-card-equal-height">
          <div class="card-body">
            <h5 class="chart-title">üìç Error Location Details</h5>
            <p class="text-muted mb-3">Detailed breakdown of errors by location</p>
            <div *ngIf="errorLocationDetails.length > 0" class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-header">
                  <tr>
                    <th>Rank</th>
                    <th>Error Location</th>
                    <th>Error Name</th>
                    <th>Count</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let detail of (showAllErrorLocationDetails ? errorLocationDetails : errorLocationDetails.slice(0, 5)); let i = index" class="location-detail-row details-expand-transition" [class.expanded]="showAllErrorLocationDetails">
                    <td>
                      <span class="rank-badge" [class.top-rank]="i < 3">{{ i + 1 }}</span>
                    </td>
                    <td>
                      <span class="badge bg-primary location-badge">{{ detail.location }}</span>
                    </td>
                    <td>
                      <span class="error-name">{{ detail.errorName }}</span>
                    </td>
                    <td>
                      <span class="count-value">{{ detail.count }}</span>
                    </td>
                    <td>
                      <button 
                        class="btn btn-sm btn-outline-primary" 
                        (click)="filterByLocationAndError(detail.location, detail.errorName)"
                        title="Filter entries by this location and error">
                        üîç Filter
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="d-flex justify-content-center mt-2">
                <button *ngIf="errorLocationDetails.length > 5" class="see-more-btn" (click)="showAllErrorLocationDetails = !showAllErrorLocationDetails">
                  {{ showAllErrorLocationDetails ? 'See Less' : 'See More' }}
                </button>
              </div>
            </div>
            <div *ngIf="errorLocationDetails.length === 0" class="text-center py-4">
              <div class="text-muted">
                <i class="fas fa-info-circle mb-2"></i>
                <p class="mb-0">No location details available for the selected filter.</p>
                <small>This may occur when error locations cannot be extracted from the error descriptions.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Entries Table -->
    <div class="row mt-4" id="entries-section" #entriesSection>
      <div class="col-12">
        <div class="card entries-card">
          <div class="card-body">
            <h5 class="chart-title">üìÑ Error Entries <span *ngIf="selectedErrorName" class="badge bg-accent ms-2">Filtered</span></h5>

            <div *ngIf="filteredEntries.length === 0" class="empty-state mt-4">
              <p>No entries found for this filter.</p>
            </div>

            <div *ngIf="filteredEntries.length > 0" class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-header">
                  <tr>
                    <th>State In Date</th>
                    <th>Event Code</th>
                    <th>Error Name</th>
                    <th>Error Location</th>
                    <th>Error Description</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let entry of (showAllErrorEntries ? filteredEntries : filteredEntries.slice(0, 5))">
                    <td>{{ formatDate(entry.state_in_date) }}</td>
                    <td>{{ entry.event_code }}</td>
                    <td>{{ entry.error_name }}</td>
                    <td>
                      <span class="badge bg-primary" *ngIf="entry.error_location && entry.error_location !== 'Unknown'">
                        {{ entry.error_location }}
                      </span>
                      <span class="text-muted" *ngIf="!entry.error_location || entry.error_location === 'Unknown'">
                        Unknown
                      </span>
                    </td>
                    <td>{{ entry.error_description }}</td>
                  </tr>
                </tbody>
              </table>
              <div class="d-flex justify-content-center mt-2">
                <button *ngIf="filteredEntries.length > 5" class="see-more-btn" (click)="showAllErrorEntries = !showAllErrorEntries">
                  {{ showAllErrorEntries ? 'See Less' : 'See More' }}
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- PM Entries Table -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card entries-card ">
          <div class="card-body">
            <h5 class="chart-title">üõ† Preventive Maintenance Entries</h5>

            <div *ngIf="pmEntries.length === 0" class="text-muted">
              No PM entries found.
            </div>

            <div *ngIf="pmEntries.length > 0" class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead class="table-header bg-info text-white">
                  <tr>
                    <th>State In Date</th>
                    
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let entry of pmEntries">
                    <td>{{ formatDate(entry.state_in_date) }}</td>
                    
                    <td>{{ entry.error_description }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
