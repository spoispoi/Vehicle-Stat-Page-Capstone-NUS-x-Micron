<div class="container-fluid factory-floor px-5 mt-4" 
     [class.dark-mode]="isDarkMode"
     [class.loading]="isDateFilterLoading">
     
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="header-title flex-grow-1" style="color: #f0f6fc;">Vehicle Statistics Page</h1>
  </div>

  <div class="top-section-container">
    <!-- Date Filter -->
    <div class="date-filter-container">
      <app-date-filter
        #dateFilter
        [startDate]="startDate"
        [endDate]="endDate"
        [earliestDate]="earliestDate"
        (dateRangeChange)="onDateRangeChange($event)"
        (filterCleared)="onFilterCleared()"
        (loadingStarted)="onDateFilterLoadingStarted()"
        (loadingEnded)="onDateFilterLoadingEnded()">
      </app-date-filter>
    </div>

    <!-- KPI Cards Section -->
    <div class="kpi-container" *ngIf="!isLoading && !isDateFilterLoading">
      <div class="kpi-card">
        <div class="kpi-label">Top Occurring Error</div>
        <div class="kpi-value">{{ topOccurringErrorName }}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Top Occurring Equipment</div>
        <div class="kpi-value">{{ topEquipment }}</div>
        <div class="kpi-sub-value" *ngIf="topErrorForTopEquipment !== 'N/A'">
          Top Error: {{ topErrorForTopEquipment }}
        </div>
      </div>
      <div class="kpi-card" (click)="scrollToLocations()" style="cursor: pointer;">
        <div class="kpi-label">Top Occurring Location</div>
        <div class="kpi-value">{{ topLocation }}</div>
        <div class="kpi-sub-value" *ngIf="topLocation !== 'N/A'">
          Count: {{ topLocationCount }}<br>
          <span *ngIf="topLocationTopErrors.length > 0">
            Top Errors:
            <ul style="margin: 0 0 0 1em; padding: 0; list-style: disc inside; font-size: 0.95em;">
              <li *ngFor="let err of topLocationTopErrors">{{ err.name }} ({{ err.count }})</li>
            </ul>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading || isDateFilterLoading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">{{ isDateFilterLoading ? 'Updating data...' : 'Loading data...' }}</p>
  </div>
   
  <!-- Section: Top 10 Errors -->
  <div class="flex-row-scroll mt-5" *ngIf="!isLoading && !isDateFilterLoading">
    <div class="scroll-chart">
      <div class="hardware-label">Hardware</div>
      <h3 class="section-title">Top 10 Errors</h3>
      <div class="chart-summary-flex">
        <div class="chart-panel" [class.shrunk]="selectedErrorName">
          <ngx-charts-bar-horizontal
            [view]="[1200, 500]"
            [scheme]="colorSchemeTopCount"
            [results]="top10ErrorData"
            [xAxis]="true"
            [yAxis]="true"
            [xAxisLabel]="'Error Count'"
            [yAxisLabel]="'Error Type'"
            [legend]="false"
            [showDataLabel]="true"
            [trimYAxisTicks]="false"
            class="white-labels"
            (select)="onBarSelect($event)">
          </ngx-charts-bar-horizontal>
        </div>
        <div class="sidebar-list">
          <ng-container *ngIf="selectedErrorName as errorKey">
            <div class="minimal-summary-panel" [@fadeSlideLeft]="errorKey">
              <div class="d-flex align-items-center mb-2">
                <span class="summary-error-name">{{ errorKey }}</span>
              </div>
              <ul class="list-unstyled minimal-summary-list mb-0">
                <li *ngFor="let sub of errorToEquipMap[errorKey]">
                  <span class="vehicle-name">{{ sub.name }}</span>
                  <span class="badge vehicle-count-badge ms-2">{{ sub.value }}</span>
                </li>
              </ul>
              <div *ngIf="!errorToEquipMap[errorKey]?.length" class="text-muted small mt-2">No data.</div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>


<!-- Section: Top Equipment with Scrollable Chart -->
<div class="flex-row-scroll" *ngIf="!isLoading && !isDateFilterLoading">
  <div class="scroll-chart">
    <h3 class="section-title">Top Equipment by Error Count</h3>
    <div class="chart-summary-flex">
      <div class="chart-panel" [class.shrunk]="selectedEquipName">
        <ngx-charts-bar-vertical
          [view]="[1200, 520]" 
          [scheme]="colorSchemeEquipTopCount"
          [results]="top20Equipments"
          [xAxis]="true"
          [yAxis]="true"
          [xAxisLabel]="'Equipment ID'"
          [yAxisLabel]="'Error Count'"
          [legend]="false"
          [yAxisTickFormatting]="yAxisTickFormatting"
          [showDataLabel]="true"
          [trimXAxisTicks]="false"
          class="white-labels"
          (select)="onEquipBarSelect($event)">
        </ngx-charts-bar-vertical>
      </div>
      <div class="sidebar-list">
        <ng-container *ngIf="selectedEquipName as equipKey">
          <div class="minimal-summary-panel" [@fadeSlideLeft]="equipKey">
            <div class="d-flex align-items-center mb-2">
              <span class="summary-error-name">{{ equipKey }}</span>
            </div>
            <ul class="list-unstyled minimal-summary-list mb-0">
              <li *ngFor="let sub of equipToErrorMap[equipKey]">
                <span class="vehicle-name">{{ sub.name }}</span>
                <span class="badge vehicle-count-badge ms-2">{{ sub.value }}</span>
              </li>
            </ul>
            <div *ngIf="!equipToErrorMap[equipKey]?.length" class="text-muted small mt-2">No data.</div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>




<!-- Section: Monthly Error Trend -->
<div class="flex-row-scroll" *ngIf="!isLoading && !isDateFilterLoading">
  <div class="scroll-chart">
    <h3 class="section-title">Error Trend by Month</h3>
    <div class="scroll-container">
      <ngx-charts-line-chart
        [view]="[1200, 500]"
        [scheme]="colorSchemeSingle"
        [results]="[{ name: 'Errors', series: errorTrendData }]"
        [xAxis]="true"
        [yAxis]="true"
        [xAxisLabel]="'Month'"
        [yAxisLabel]="'Error Count'"
        [legend]="false"
        [autoScale]="true">
      </ngx-charts-line-chart>
    </div>
  </div>
  <div class="sidebar-list">
    <h3 class="section-title">Top 5 Months</h3>
    <div class="accordion">
      <div class="accordion-item" *ngFor="let item of top5Months; let i = index">
        <div class="accordion-header" (click)="toggleMonth(i)">
          <div class="error-name">{{ item.name }}</div>
          <div class="d-flex align-items-center">
            <span class="badge error-count-badge">{{ item.value }}</span>
            <span class="chevron-icon" [class.rotate]="expandedMonthIndex === i">‚ñº</span>
          </div>
        </div>
        <div class="accordion-content" [@collapseAnimation]="expandedMonthIndex === i ? 'expanded' : 'collapsed'">
          <div *ngIf="monthRowLoading[item.name]" class="text-center my-2">
            <div class="spinner-border text-warning spinner-border-sm" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <ul class="list-unstyled ms-2 vehicle-list"
              *ngIf="!monthRowLoading[item.name] && (monthToErrorMapFiltered[item.name]?.length || 0) > 0; else noMonthErrors">
            <li *ngFor="let sub of monthToErrorMapFiltered[item.name]">
              <span class="vehicle-name">‚ñ∏ {{ sub.name }}</span>
              <span class="badge vehicle-count-badge">{{ sub.value }}</span>
            </li>
          </ul>
          <ng-template #noMonthErrors>
            <p class="text-muted small ms-2">No matching data found.</p>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>



 <!-- Section: Multi-line Error Trends -->
<div class="flex-row-scroll" *ngIf="!isLoading && !isDateFilterLoading">
  <div class="scroll-chart">
    <h3 class="section-title">Error Trends by Error Type</h3>
    <div class="scroll-container">
      <ngx-charts-line-chart
        [view]="[1200, 500]"
        [scheme]="colorScheme"
        [results]="errorTrendMultiLineData"
        [xAxis]="true"
        [yAxis]="true"
        [legend]="true"
        [showGridLines]="true"
        [roundDomains]="true"
        [xAxisLabel]="'Month'"
        [yAxisLabel]="'Error Count'">
      </ngx-charts-line-chart>
    </div>
  </div>
  <div class="sidebar-list">
    <h3 class="section-title">Filter Errors for Error Trend</h3>
    <div class="custom-dropdown">
      <button class="dropdown-toggle-button" (click)="showDropdown = !showDropdown">
        <span>Select Errors</span>
        <span class="chevron-icon" [class.rotate]="showDropdown">‚ñº</span>
      </button>
      <div class="dropdown-content" [@collapseAnimation]="showDropdown ? 'expanded' : 'collapsed'">
        <div class="dropdown-search">
          <input type="text" class="form-control" placeholder="Search Errors" (input)="onSearchError($event)" />
        </div>
        <div class="error-list">
          <div class="form-check" *ngFor="let error of filteredErrorTypes; let i = index">
            <input class="form-check-input" type="checkbox" [id]="'error-' + i"
                   [checked]="selectedErrorTypes.includes(error)"
                   (change)="onErrorTypeToggle(error)">
            <label class="form-check-label" [for]="'error-' + i">{{ error }}</label>
          </div>
        </div>
        <div class="dropdown-actions">
          <button class="btn btn-action btn-danger" (click)="clearAllErrors()">Unselect All</button>
          <button class="btn btn-action btn-success" (click)="selectTopErrors()">Select Top 5</button>
        </div>
      </div>
    </div>
  </div>
</div>



    <!-- Search Bar -->
    <div class="input-group mb-4 justify-content-center" *ngIf="!isLoading && !isDateFilterLoading">
      <input type="text" class="form-control w-100 shadow-sm bg-dark text-light border-secondary" placeholder="Search by Equip ID" (input)="onSearch($event)" />
    </div>
  

<!-- Tool Cards (Scrollable Grid) -->
<div class="tool-list-scrollable" *ngIf="!isLoading && !isDateFilterLoading">
  <div class="tool-card" 
       *ngFor="let tool of visibleTools; trackBy: trackByEquipId"
       [@fadeInOut]
       [class.top-10-tool]="isTop10Tool(tool.equip_id)">
    <div class="tool-card-content">
      <div class="tool-header">
        <h5 class="tool-id">
          {{ tool.equip_id }}
          <span class="top-10-badge" *ngIf="isTop10Tool(tool.equip_id)">üî• TOP 10</span>
        </h5>
      </div>
      <div class="tool-body">
        <p><span class="label">üõ† Most Recent Error:</span><br>{{ tool.most_recent_error || 'N/A' }}</p>
        <p><span class="label">üìÖ Most Recent Error Date:</span><br>{{ tool.most_recent_date || 'N/A' }}</p>
        <p><span class="label">üìä Total Errors:</span><br><span class="error-count">{{ tool.error_count }}</span></p>
      </div>
    </div>
    <div class="tool-card-actions">
      <button class="btn btn-primary w-100" (click)="navigateToStatistics(tool.equip_id)">View Statistics</button>
    </div>
  </div>
</div>

<!-- See More/See Less Button for Tool Cards -->
<div class="d-flex justify-content-center mt-2" *ngIf="!isLoading && !isDateFilterLoading && filteredTools.length > 14">
  <button class="see-more-btn" (click)="toggleShowAllTools()">
    {{ showAllTools ? 'See Less' : 'See More' }}
  </button>
</div>

<!-- Error Location Leaderboard Section -->
<div class="locations-label" *ngIf="!isLoading && !isDateFilterLoading">
  Locations
  <span class="filter-indicator" *ngIf="hasActiveFilter()">
    <i class="fas fa-filter"></i>
    {{ getFilterIndicatorText() }}
  </span>
</div>

<div id="locations-section" class="container-fluid" *ngIf="!isLoading && !isDateFilterLoading && errorLocationData.length > 0">
  <div class="card leaderboard-card">
    <div class="card-body">
      <h3 class="section-title">üìç Top Error Locations Leaderboard</h3>
      <p class="text-muted small mb-3">Error count by location across all equipment</p>
      <div class="table-responsive">
        <ng-container *ngIf="!showAllLeaderboard">
          <table #collapsedTable class="table align-middle leaderboard-table">
            <thead class="table-header">
              <tr>
                <th style="width: 80px;">Rank</th>
                <th style="width: 200px;">Error Location</th>
                <th style="width: 300px;">Top 3 Error Names</th>
                <th style="width: 100px; text-align: left;">Count</th>
                <th style="width: 120px;">% of Total</th>
                <th style="width: 180px;">Most Recent Error</th>
                <th style="width: 160px;">Most Recent Error Date</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let detail of errorLocationDetails.slice(0, 10); let i = index" class="location-detail-row">
                <td>
                  <span class="rank-badge" [class.top-rank]="i < 3">{{ i + 1 }}</span>
                </td>
                <td>
                  <span class="location-name">{{ detail.location }}</span>
                </td>
                <td>
                  <div class="top-errors">
                    <div *ngFor="let error of detail.topErrors; let j = index" class="error-item">
                      <span class="error-name">{{ error.name }} <span class="error-count">({{ error.count }})</span></span>
                    </div>
                    <div *ngIf="detail.topErrors.length === 0" class="no-errors">
                      No specific errors
                    </div>
                  </div>
                </td>
                <td style="text-align: left;">
                  <span class="count-value">{{ detail.count }}</span>
                </td>
                <td>
                  <span class="percentage-value">{{ detail.percentage.toFixed(1) }}%</span>
                </td>
                <td>
                  <span class="most-recent-error">{{ detail.most_recent_error }}</span>
                </td>
                <td>
                  <span class="most-recent-date">{{ detail.most_recent_date }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </ng-container>
        <ng-container *ngIf="showAllLeaderboard">
          <div class="leaderboard-scroll" [style.minHeight.px]="collapsedTableHeight">
            <table class="table align-middle leaderboard-table">
              <thead class="table-header">
                <tr>
                  <th style="width: 80px;">Rank</th>
                  <th style="width: 200px;">Error Location</th>
                  <th style="width: 300px;">Top 3 Error Names</th>
                  <th style="width: 100px; text-align: left;">Count</th>
                  <th style="width: 120px;">% of Total</th>
                  <th style="width: 180px;">Most Recent Error</th>
                  <th style="width: 160px;">Most Recent Error Date</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let detail of errorLocationDetails; let i = index" class="location-detail-row">
                  <td>
                    <span class="rank-badge" [class.top-rank]="i < 3">{{ i + 1 }}</span>
                  </td>
                  <td>
                    <span class="location-name">{{ detail.location }}</span>
                  </td>
                  <td>
                    <div class="top-errors">
                      <div *ngFor="let error of detail.topErrors; let j = index" class="error-item">
                        <span class="error-name">{{ error.name }} <span class="error-count">({{ error.count }})</span></span>
                      </div>
                      <div *ngIf="detail.topErrors.length === 0" class="no-errors">
                        No specific errors
                      </div>
                    </div>
                  </td>
                  <td style="text-align: left;">
                    <span class="count-value">{{ detail.count }}</span>
                  </td>
                  <td>
                    <span class="percentage-value">{{ detail.percentage.toFixed(1) }}%</span>
                  </td>
                  <td>
                    <span class="most-recent-error">{{ detail.most_recent_error }}</span>
                  </td>
                  <td>
                    <span class="most-recent-date">{{ detail.most_recent_date }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>
      </div>
      <!-- See More/See Less Button for Leaderboard Table -->
      <div class="text-center mt-2">
        <button class="see-more-btn" (click)="toggleLeaderboard()">
          {{ showAllLeaderboard ? 'See Less' : 'See More' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Section: Top Error Locations -->
<div class="flex-row-scroll mt-5" *ngIf="!isLoading && !isDateFilterLoading">
  <div class="scroll-chart">
    <h3 class="section-title">Top 10 Error Locations</h3>
    <div class="chart-summary-flex">
      <div class="chart-panel" [class.shrunk]="selectedLocationName">
        <ngx-charts-bar-horizontal
          [view]="[1200, 500]"
          [scheme]="colorSchemeLocationTopCount"
          [results]="topErrorLocationsData"
          [xAxis]="true"
          [yAxis]="true"
          [xAxisLabel]="'Error Count'"
          [yAxisLabel]="'Location'"
          [legend]="false"
          [showDataLabel]="true"
          [trimYAxisTicks]="false"
          class="white-labels"
          (select)="onLocationBarSelect($event)">
        </ngx-charts-bar-horizontal>
      </div>
      <div class="sidebar-list">
        <ng-container *ngIf="selectedLocationName as locationKey">
          <div class="minimal-summary-panel" [@fadeSlideLeft]="locationKey">
            <div class="d-flex align-items-center mb-2">
              <span class="summary-error-name">{{ locationKey }}</span>
            </div>
            <ul class="list-unstyled minimal-summary-list mb-0">
              <li *ngFor="let sub of locationToErrorMap[locationKey]">
                <span class="vehicle-name">{{ sub.name }}</span>
                <span class="badge vehicle-count-badge ms-2">{{ sub.value }}</span>
              </li>
            </ul>
            <div *ngIf="!locationToErrorMap[locationKey]?.length" class="text-muted small mt-2">No data.</div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<!-- Section: Error Location Trends -->
<div class="flex-row-scroll mt-5" *ngIf="!isLoading && !isDateFilterLoading">
  <div class="scroll-chart">
    <h3 class="section-title">Error Location Trends by Month</h3>
    <!-- Filter Notification -->
    <div class="filter-notification" *ngIf="appliedLocationFilter">
      <span class="filter-badge">{{ appliedLocationFilter }}</span>
    </div>
    <div class="scroll-container">
      <ngx-charts-line-chart
        [view]="[1200, 500]"
        [scheme]="colorScheme"
        [results]="errorLocationTrendMultiLineData"
        [xAxis]="true"
        [yAxis]="true"
        [legend]="true"
        [showGridLines]="true"
        [roundDomains]="true"
        [xAxisLabel]="'Month'"
        [yAxisLabel]="'Error Count'">
      </ngx-charts-line-chart>
    </div>
  </div>
  <div class="sidebar-list">
    <h3 class="section-title">Filter Locations for Location Trend</h3>
    <div class="custom-dropdown">
      <button class="dropdown-toggle-button" (click)="showLocationDropdown = !showLocationDropdown">
        <span>Select Locations</span>
        <span class="chevron-icon" [class.rotate]="showLocationDropdown">‚ñº</span>
      </button>
      <div class="dropdown-content" [@collapseAnimation]="showLocationDropdown ? 'expanded' : 'collapsed'">
        <div class="dropdown-search">
          <input type="text" class="form-control" placeholder="Search Locations" (input)="onSearchLocation($event)" />
        </div>
        <div class="error-list">
          <div class="form-check" *ngFor="let location of filteredLocationTypes; let i = index">
            <input class="form-check-input" type="checkbox" [id]="'location-' + i"
                   [checked]="selectedLocationTypes.includes(location)"
                   (change)="onLocationTypeToggle(location)">
            <label class="form-check-label" [for]="'location-' + i">{{ location }}</label>
          </div>
        </div>
        <div class="dropdown-actions">
          <button class="btn btn-action btn-danger" (click)="clearAllLocations()">Unselect All</button>
          <button class="btn btn-action btn-success" (click)="selectTopLocations()">Select Top 5</button>
        </div>
      </div>
    </div>
  </div>
</div>


