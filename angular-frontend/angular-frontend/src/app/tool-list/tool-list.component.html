<div class="container-fluid factory-floor px-5 mt-4" 
     [class.dark-mode]="isDarkMode">
     
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="header-title flex-grow-1" style="color: #f0f6fc;">Vehicle Statistics Page</h1>
  </div>

  <div class="top-section-container">
    <!-- Date Filter -->
    <div class="date-filter-container">
      <app-date-filter
        [startDate]="startDate"
        [endDate]="endDate"
        [earliestDate]="earliestDate"
        (dateRangeChange)="onDateRangeChange($event)"
        (filterCleared)="onFilterCleared()">
      </app-date-filter>
    </div>

    <!-- KPI Cards Section -->
    <div class="kpi-container" *ngIf="!isLoading">
      <div class="kpi-card">
        <div class="kpi-label">Top Occurring Error</div>
        <div class="kpi-value">{{ topOccurringErrorName }}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Top Occurring Equipment</div>
        <div class="kpi-value">{{ topEquipment }}</div>
        <div class="kpi-sub-value" *ngIf="topErrorForTopEquipment !== 'N/A'">
          Top Error: {{ topErrorForTopEquipment }}
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Top Occurring Location</div>
        <div class="kpi-value">{{ topLocation }}</div>
        <div class="kpi-sub-value" *ngIf="topLocation !== 'N/A'">
          Count: {{ topLocationCount }}<br>
          <span *ngIf="topLocationTopErrors.length > 0">
            Top Errors:
            <ul style="margin: 0 0 0 1em; padding: 0; list-style: disc inside; font-size: 0.95em;">
              <li *ngFor="let err of topLocationTopErrors">{{ err.name }} ({{ err.count }})</li>
            </ul>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading data...</p>
  </div>
   
  <!-- Section: Top 10 Errors -->
  <div class="flex-row-scroll mt-5" *ngIf="!isLoading">
    <div class="scroll-chart">
      <h3 class="section-title">Top 10 Errors</h3>
      <div class="chart-summary-flex">
        <div class="chart-panel" [class.shrunk]="selectedErrorName">
          <ngx-charts-bar-horizontal
            [view]="[1200, 500]"
            [scheme]="colorSchemeTopCount"
            [results]="top10ErrorData"
            [xAxis]="true"
            [yAxis]="true"
            [xAxisLabel]="'Error Count'"
            [yAxisLabel]="'Error Type'"
            [legend]="false"
            [showDataLabel]="true"
            [trimYAxisTicks]="false"
            class="white-labels"
            (select)="onBarSelect($event)">
          </ngx-charts-bar-horizontal>
        </div>
        <div class="sidebar-list">
          <ng-container *ngIf="selectedErrorName as errorKey">
            <div class="minimal-summary-panel" [@fadeSlideLeft]="errorKey">
              <div class="d-flex align-items-center mb-2">
                <span class="summary-error-name">{{ errorKey }}</span>
              </div>
              <ul class="list-unstyled minimal-summary-list mb-0">
                <li *ngFor="let sub of errorToEquipMap[errorKey]">
                  <span class="vehicle-name">{{ sub.name }}</span>
                  <span class="badge vehicle-count-badge ms-2">{{ sub.value }}</span>
                </li>
              </ul>
              <div *ngIf="!errorToEquipMap[errorKey]?.length" class="text-muted small mt-2">No data.</div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>


<!-- Section: Top Equipment with Scrollable Chart -->
<div class="flex-row-scroll" *ngIf="!isLoading">
  <div class="scroll-chart">
    <h3 class="section-title">Top Equipment by Error Count</h3>
    <div class="chart-summary-flex">
      <div class="chart-panel" [class.shrunk]="selectedEquipName">
        <ngx-charts-bar-vertical
          [view]="[1200, 520]" 
          [scheme]="colorSchemeEquipTopCount"
          [results]="top20Equipments"
          [xAxis]="true"
          [yAxis]="true"
          [xAxisLabel]="'Equipment ID'"
          [yAxisLabel]="'Error Count'"
          [legend]="false"
          [yAxisTickFormatting]="yAxisTickFormatting"
          [showDataLabel]="true"
          [trimXAxisTicks]="false"
          class="white-labels"
          (select)="onEquipBarSelect($event)">
        </ngx-charts-bar-vertical>
      </div>
      <div class="sidebar-list">
        <ng-container *ngIf="selectedEquipName as equipKey">
          <div class="minimal-summary-panel" [@fadeSlideLeft]="equipKey">
            <div class="d-flex align-items-center mb-2">
              <span class="summary-error-name">{{ equipKey }}</span>
            </div>
            <ul class="list-unstyled minimal-summary-list mb-0">
              <li *ngFor="let sub of equipToErrorMap[equipKey]">
                <span class="vehicle-name">{{ sub.name }}</span>
                <span class="badge vehicle-count-badge ms-2">{{ sub.value }}</span>
              </li>
            </ul>
            <div *ngIf="!equipToErrorMap[equipKey]?.length" class="text-muted small mt-2">No data.</div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>




<!-- Section: Monthly Error Trend -->
<div class="flex-row-scroll" *ngIf="!isLoading">
  <div class="scroll-chart">
    <h3 class="section-title">Error Trend by Month</h3>
    <div class="scroll-container">
      <ngx-charts-line-chart
        [view]="[1200, 500]"
        [scheme]="colorSchemeSingle"
        [results]="[{ name: 'Errors', series: errorTrendData }]"
        [xAxis]="true"
        [yAxis]="true"
        [xAxisLabel]="'Month'"
        [yAxisLabel]="'Error Count'"
        [legend]="false"
        [autoScale]="true">
      </ngx-charts-line-chart>
    </div>
  </div>
  <div class="sidebar-list">
    <h3 class="section-title">Top 5 Months</h3>
    <div class="accordion">
      <div class="accordion-item" *ngFor="let item of top5Months; let i = index">
        <div class="accordion-header" (click)="toggleMonth(i)">
          <div class="error-name">{{ item.name }}</div>
          <div class="d-flex align-items-center">
            <span class="badge error-count-badge">{{ item.value }}</span>
            <span class="chevron-icon" [class.rotate]="expandedMonthIndex === i">â–¼</span>
          </div>
        </div>
        <div class="accordion-content" [@collapseAnimation]="expandedMonthIndex === i ? 'expanded' : 'collapsed'">
          <div *ngIf="monthRowLoading[item.name]" class="text-center my-2">
            <div class="spinner-border text-warning spinner-border-sm" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <ul class="list-unstyled ms-2 vehicle-list"
              *ngIf="!monthRowLoading[item.name] && (monthToErrorMap[item.name]?.length || 0) > 0; else noMonthErrors">
            <li *ngFor="let sub of monthToErrorMap[item.name]">
              <span class="vehicle-name">â–¸ {{ sub.name }}</span>
              <span class="badge vehicle-count-badge">{{ sub.value }}</span>
            </li>
          </ul>
          <ng-template #noMonthErrors>
            <p class="text-muted small ms-2">No matching data found.</p>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>



 <!-- Section: Multi-line Error Trends -->
<div class="flex-row-scroll" *ngIf="!isLoading">
  <div class="scroll-chart">
    <h3 class="section-title">Error Trends by Error Type</h3>
    <div class="scroll-container">
      <ngx-charts-line-chart
        [view]="[1200, 500]"
        [scheme]="colorScheme"
        [results]="errorTrendMultiLineData"
        [xAxis]="true"
        [yAxis]="true"
        [legend]="true"
        [showGridLines]="true"
        [roundDomains]="true"
        [xAxisLabel]="'Month'"
        [yAxisLabel]="'Error Count'">
      </ngx-charts-line-chart>
    </div>
  </div>
  <div class="sidebar-list">
    <h3 class="section-title">Filter Errors for Error Trend</h3>
    <div class="custom-dropdown">
      <button class="dropdown-toggle-button" (click)="showDropdown = !showDropdown">
        <span>Select Errors</span>
        <span class="chevron-icon" [class.rotate]="showDropdown">â–¼</span>
      </button>
      <div class="dropdown-content" [@collapseAnimation]="showDropdown ? 'expanded' : 'collapsed'">
        <div class="dropdown-search">
          <input type="text" class="form-control" placeholder="Search Errors" (input)="onSearchError($event)" />
        </div>
        <div class="error-list">
          <div class="form-check" *ngFor="let error of filteredErrorTypes; let i = index">
            <input class="form-check-input" type="checkbox" [id]="'error-' + i"
                   [checked]="selectedErrorTypes.includes(error)"
                   (change)="onErrorTypeToggle(error)">
            <label class="form-check-label" [for]="'error-' + i">{{ error }}</label>
          </div>
        </div>
        <div class="dropdown-actions">
          <button class="btn btn-action btn-danger" (click)="clearAllErrors()">Unselect All</button>
          <button class="btn btn-action btn-success" (click)="selectTopErrors()">Select Top 5</button>
        </div>
      </div>
    </div>
  </div>
</div>



    <!-- Search Bar -->
    <div class="input-group mb-4 justify-content-center" *ngIf="!isLoading">
      <input type="text" class="form-control w-100 shadow-sm bg-dark text-light border-secondary" placeholder="Search by Equip ID" (input)="onSearch($event)" />
    </div>
  

<!-- Tool Cards (Scrollable Grid) -->
<div class="tool-list-scrollable" *ngIf="!isLoading">
  <div class="tool-card" 
       *ngFor="let tool of visibleTools; trackBy: trackByEquipId"
       [@fadeInOut]
       [class.top-10-tool]="isTop10Tool(tool.equip_id)">
    <div class="tool-card-content">
      <div class="tool-header">
        <h5 class="tool-id">
          {{ tool.equip_id }}
          <span class="top-10-badge" *ngIf="isTop10Tool(tool.equip_id)">ðŸ”¥ TOP 10</span>
        </h5>
      </div>
      <div class="tool-body">
        <p><span class="label">ðŸ›  Most Recent Error:</span><br>{{ tool.most_recent_error || 'N/A' }}</p>
        <p><span class="label">ðŸ“… Most Recent Error Date:</span><br>{{ tool.most_recent_date || 'N/A' }}</p>
        <p><span class="label">ðŸ“Š Total Errors:</span><br><span class="error-count">{{ tool.error_count }}</span></p>
      </div>
    </div>
    <div class="tool-card-actions">
      <button class="btn btn-primary w-100" (click)="navigateToStatistics(tool.equip_id)">View Statistics</button>
    </div>
  </div>
</div>
<div class="d-flex justify-content-center mt-2" *ngIf="filteredTools.length > 14">
  <button class="see-more-btn" (click)="toggleShowAllTools()">
    <span style="font-size:1.2em;vertical-align:middle;margin-right:0.5em;">
      {{ showAllTools ? 'â–²' : 'â–¼' }}
    </span>
    {{ showAllTools ? 'See Less' : 'See More' }}
  </button>
</div>


